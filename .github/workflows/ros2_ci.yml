name: ROS 2 CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  ros_ci:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        ros_distro: [humble]

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup ROS 2
      - name: ‚öôÔ∏è Setup ROS 2
        uses: ros-tooling/setup-ros@v0.7
        with:
          ros-distro: ${{ matrix.ros_distro }}

      # 3Ô∏è‚É£ Build, Test & Lint (ALL packages inside src/)
      - name: üèóÔ∏è Build, Test, and Lint ROS 2 Packages
        uses: ros-tooling/action-ros-ci@v0.4
        with:
          target-ros2-distro: ${{ matrix.ros_distro }}

          # Build all packages found inside src/
          colcon-arguments: |
            --event-handlers console_direct+

          build-args: |
            --cmake-args -DCMAKE_BUILD_TYPE=Release

          # Run tests sequentially for stability
          test-args: |
            --executor sequential

      # 4Ô∏è‚É£ Optional custom linters (repo-relative paths only)
      - name: üìù Custom Code Quality Checks
        run: |
          echo "Optional custom linters"
          # flake8 src/
          # cppcheck --enable=all --inconclusive --std=c++17 src/

      # 5Ô∏è‚É£ Upload logs (NO hard-coded paths)
      - name: üì¶ Upload Test Results & Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.ros_distro }}-ci-logs
          path: log/
